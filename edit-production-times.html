<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Edit Production Times</title>
</head>

<body style="font-family: Arial; max-width: 500px; margin: 40px auto;">

  <h2>Edit Production Times</h2>

  <form id="timesForm">
    <label>
      Screen Print<br>
      <input type="text" id="screen_print">
    </label><br><br>

    <label>
      Embroidery<br>
      <input type="text" id="embroidery">
    </label><br><br>

    <label>
      DTF<br>
      <input type="text" id="dtf">
    </label><br><br>

    <button type="submit">Save Changes</button>
  </form>

  <p id="status" style="margin-top:20px; font-weight: bold;"></p>

  <br>

  <button 
    onclick="window.location.href='login.html'"
    style="
      background:#b6282c;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
    "
  >
    ‚Üê Back to Menu
  </button>

  <!-- SCRIPT BLOCK -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://sbfslzwnkztmodnlsigq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg";

  const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const originalValues = {};

  async function guardPage() {
    const { data, error } = await client.auth.getSession();
    if (error || !data.session) {
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  async function loadProductionTimes() {
    const { data, error } = await client
      .from("production_times")
      .select("id, display_value");

    if (error) {
      console.error(error);
      document.getElementById("status").textContent =
        "Error loading production times.";
      return;
    }

    data.forEach(row => {
      originalValues[row.id] = row.display_value;
      const input = document.getElementById(row.id);
      if (input) {
        input.value = row.display_value;
      }
    });
  }

  async function saveProductionTimes() {
  const status = document.getElementById("status");
  status.textContent = "Saving...";

  const updates = [];

  const fields = ["screen_print", "embroidery", "dtf"];

  fields.forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;

    const newValue = input.value.trim();
    const oldValue = originalValues[id];

    // Only update if:
    // - field is not empty
    // - value actually changed
    if (newValue !== "" && newValue !== oldValue) {
      updates.push({ id, display_value: newValue });
    }
  });

  if (updates.length === 0) {
    status.textContent = "No changes to save.";
    return;
  }

  for (const row of updates) {
    const { data, error: updateError } = await client
      .from("production_times")
      .update({ display_value: row.display_value })
      .eq("id", row.id)
      .select();

    if (updateError) {
      console.error("SUPABASE UPDATE ERROR:", updateError);
      status.textContent = "Error: " + updateError.message;
      return;
    }

    if (!data || data.length === 0) {
      console.warn("No rows updated for ID:", row.id);
    }
  }

  // Update local originals so repeated saves work correctly
  updates.forEach(row => {
    originalValues[row.id] = row.display_value;
  });

  status.textContent = "Production times updated successfully!";
}


  document.addEventListener("DOMContentLoaded", async () => {
    const ok = await guardPage();
    if (!ok) return;

    await loadProductionTimes();

    document
      .getElementById("timesForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveProductionTimes();
      });
  });
</script>


</body>
</html>
