<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
  // Initialize Supabase
  const client = supabase.createClient(
    'https://sbfslzwnkztmodnlsigq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg'
  );

  // PAGE GUARD: Block the page if user is not logged in
  async function guardPage() {
    const { data } = await client.auth.getSession();
    if (!data.session) {
      window.location.replace("login.html");
      return;
    }
  }

  // Run immediately
  guardPage();


  // HANDLE FORM SUBMISSION
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const status = document.getElementById('status');
      status.textContent = "Saving...";

      const vendor = document.getElementById('vendor').value;
      const style_num = document.getElementById('style_num').value;
      const product_title = document.getElementById('product_title').value;
      const piece_weight = document.getElementById('piece_weight').value;
      const size = document.getElementById('size').value;

      // Get logged-in user
      const { data: sessionData } = await client.auth.getSession();
      const user_id = sessionData?.session?.user?.id || null;

      // Insert the new item
      const { data, error } = await client
        .from('user_added_items')
        .insert([
          {
            vendor,
            style_num,
            product_title,
            piece_weight: piece_weight ? Number(piece_weight) : null,
            size,
            created_by: user_id
          }
        ]);

      if (error) {
        status.textContent = "Error: " + error.message;
      } else {
        status.textContent = "Item saved successfully!";
        document.getElementById('itemForm').reset();
      }
    });
  });
</script>
