<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <meta charset="UTF-8">
  <title>Add User Item</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    window.supabase = { createClient };
  </script>

</head>

<body style="font-family: Arial; max-width: 500px; margin: 40px auto;">
  
  <h2>Add User Item</h2>

  <form id="itemForm">
    <label>Vendor (required)<br>
      <select id="vendor" required>
      <option value="">Loading vendors…</option>
      </select>
    </label><br><br>

    <label>Style Number (required)<br>
      <input type="text" id="style_num" required>
    </label><br><br>

    <label>Product Title<br>
      <input type="text" id="product_title">
    </label><br><br>

    <label>Piece Weight<br>
      <input type="number" step="0.0001" id="piece_weight">
    </label><br><br>

    <label>Size<br>
  <select id="size" required>
    <option value="">Loading sizes…</option>
  </select>
</label><br><br>


    <button type="submit">Save Item</button>
  </form>

  <hr style="margin: 40px 0;">

  <h2>Bulk Import Items (CSV Upload)</h2>

  <p>Upload a CSV file with the columns:</p>
  <p><code>vendor,style_num,product_title,piece_weight,size</code></p>

  <input type="file" id="csvFile" accept=".csv"><br><br>

  <button id="importBtn">Import CSV</button>

  <p id="bulkStatus" style="margin-top:20px; font-weight: bold;"></p>


  <p id="status" style="margin-top:20px;"></p>


  <!-- SCRIPT BLOCK -->
  <script>
    // Initialize Supabase
   const client = supabase.createClient(
     "https://sbfslzwnkztmodnlsigq.supabase.co",
     "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg"
    );

    // PAGE GUARD — redirect if not logged in
    async function guardPage() {
      const { data, error } = await client.auth.getSession();
      if (error) {
        console.error("Session error:", error);
        return;
      }
      if (!data.session) {
        window.location.href = "login.html";
      }
    }

async function loadSizes() {
  const dropdown = document.getElementById('size');

  const { data, error } = await client
    .from('sizes')          // your table name
    .select('name')         // the column you created
    .eq('is_active', true)  // optional filter
    .order('name', { ascending: true });

  if (error) {
    console.error("Error loading sizes:", error);
    dropdown.innerHTML = `<option value="">Error loading sizes</option>`;
    return;
  }

  dropdown.innerHTML = `<option value="">Select a size</option>`;

  data.forEach(row => {
    const opt = document.createElement('option');
    opt.value = row.name;
    opt.textContent = row.name;
    dropdown.appendChild(opt);
  });
}

// Load vendors from Supabase
async function loadVendors() {
  const dropdown = document.getElementById('vendor');

  const { data, error } = await client
    .from('vendors')        // your table name
    .select('name')         // your column name
    .eq('is_active', true)  // optional filter
    .order('name', { ascending: true });

  if (error) {
    console.error("Error loading vendors:", error);
    dropdown.innerHTML = `<option value="">Error loading vendors</option>`;
    return;
  }

  dropdown.innerHTML = `<option value="">Select a vendor</option>`;

  data.forEach(row => {
    const opt = document.createElement('option');
    opt.value = row.name;
    opt.textContent = row.name;
    dropdown.appendChild(opt);
  });
}

  // WAIT FOR PAGE + FORMS TO LOAD
  document.addEventListener('DOMContentLoaded', function () {

    guardPage(); // run guard check after page loads
  loadVendors();  // load vendor list into dropdown
  loadSizes();  // load sizes from dropdown

    const form = document.getElementById('itemForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const status = document.getElementById('status');
      status.textContent = "Saving...";

      const vendor = document.getElementById('vendor').value;
      const style_num = document.getElementById('style_num').value;
      const product_title = document.getElementById('product_title').value;
      const piece_weight = document.getElementById('piece_weight').value;
      const size = document.getElementById('size').value;

      // Get logged-in user
      const { data: sessionData } = await client.auth.getSession();
      const user_name = sessionData?.session?.user?.email || null;

      // Insert the new item
      const { error } = await client
        .from('user_added_items')
        .insert([
          {
            vendor,
            style_num,
            product_title,
            piece_weight: piece_weight ? Number(piece_weight) : null,
            size,
            created_by: user_name
          }
        ]);

      if (error) {
        status.textContent = "Error: " + error.message;
      } else {
        status.textContent = "Item saved successfully!";
        form.reset();
      }
    });
  });
  
// =========================
// BULK CSV IMPORT HANDLER
// =========================

document.getElementById('importBtn').addEventListener('click', async () => {
  const file = document.getElementById('csvFile').files[0];
  const bulkStatus = document.getElementById('bulkStatus');

  if (!file) {
    bulkStatus.textContent = "Please choose a CSV file first.";
    return;
  }

  bulkStatus.textContent = "Processing CSV...";

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async function(results) {

      const rows = results.data;

      // Get logged-in user info for created_by
      const { data: sessionData } = await client.auth.getSession();
      const user_name =
        sessionData?.session?.user?.user_metadata?.name ||
        sessionData?.session?.user?.email ||
        null;

      // Convert CSV rows into Supabase-ready objects
      const formattedRows = rows.map(r => ({
        vendor: r.vendor,
        style_num: r.style_num,
        product_title: r.product_title,
        piece_weight: r.piece_weight ? Number(r.piece_weight) : null,
        size: r.size,
        created_by: user_name
      }));

      // Bulk insert into Supabase
      const { error } = await client
        .from('user_added_items')
        .insert(formattedRows);

      if (error) {
        console.error(error);
        bulkStatus.textContent = "Error importing: " + error.message;
      } else {
        bulkStatus.textContent = 
          "Successfully imported " + rows.length + " items!";
        document.getElementById('csvFile').value = "";   // <-- clears the filename  
      }
    }
  });
});
 
</script>

<button 
    onclick="window.location.href='login.html'" 
    style="
      background:#b6282c;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      margin-bottom:20px;
    "
  >
    ← Back to Menu
  </button>

  <button 
    onclick="window.location.href='index.html'" 
    style="
      background:#b6282c;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      margin-bottom:20px;
    "
  >
    Shipping Calc
  </button>
  
</body>
</html>
