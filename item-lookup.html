<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Item Weight & Shipping Lookup</title>
<style>
  body {font-family: Arial, Helvetica, sans-serif; background: #fff; color: #111; margin: 0; padding: 24px;}
  .container {max-width: 1100px; margin: 0 auto;}
  h1 {color: #000; margin-bottom: 4px;}
  .sub {color:#555; margin:0 0 18px; font-size:14px;}
  .search-bar {display: grid; grid-template-columns: 1fr 1fr 120px; gap: 10px; margin-bottom: 10px;}
  input, button {padding: 10px; border-radius: 8px; font-size: 15px; box-sizing:border-box;}
  input {border: 1px solid #ccc;}
  input:focus {border-color:#c40000; outline:none; box-shadow:0 0 0 2px rgba(196,0,0,.15);}
  button {background: #c40000; color: #fff; border: 1px solid #c40000; cursor: pointer; font-weight:600;}
  button:hover {filter: brightness(0.93);}
  table {width: 100%; border-collapse: collapse; margin-top: 10px;}
  th, td {border: 1px solid #ddd; padding: 8px; text-align: left; font-size:13px;}
  th {background: #f4f4f4; cursor: pointer; user-select:none;}
  tr:hover td {background: #f9f9f9;}
  .muted {color: #555; font-size: 13px; margin-top:4px;}
  .badge {display:inline-block; padding:1px 6px; border-radius:999px; border:1px solid #ddd; font-size:11px; background:#fafafa;}
  #tableWrap {display:none;}
  @media (max-width:760px){
    .search-bar {grid-template-columns: 1fr;}
    th, td {font-size:12px;}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Item Weight & Shipping Lookup</h1>
  <p class="sub">
    Search by <strong>Item # (exact)</strong> or <strong>Description keywords</strong>.  
    Results include vendor, weight, and shipping/handling levels.
  </p>

  <div class="search-bar">
    <input type="text" id="itemInput" placeholder="Item # (exact)">
    <input type="text" id="descInput" placeholder="Description keywords">
    <button id="clearBtn">Clear</button>
  </div>
  <div id="status" class="muted">Type an Item # (exact) or at least 2 characters in Description.</div>

  <div id="tableWrap">
    <table id="resultTable">
     <thead>
  <tr>
    <th data-k="vendor">Vendor</th>
    <th data-k="style_num">Style #</th>
    <th data-k="product_title">Title</th>
    <th data-k="size">Size</th>
    <th data-k="piece_weight">Weight (lb)</th>
    <th>Ship level</th>
    <th>Shipping $ min</th>
    <th>Shipping $/Item</th>
    <th>Handling $ min</th>
    <th>Handling $/Item</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ====== SET THESE TWO VALUES TO YOUR PROJECT ======
  const SUPABASE_URL  = "https://sbfslzwnkztmodnlsigq.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg";
  // ==================================================

  const API_ITEMS   = `${SUPABASE_URL}/rest/v1/items_unified`;
  const API_LEVELS  = `${SUPABASE_URL}/rest/v1/shipping_levels`;

  document.addEventListener("DOMContentLoaded", () => {
    const itemInput  = document.getElementById("itemInput");
    const descInput  = document.getElementById("descInput");
    const clearBtn   = document.getElementById("clearBtn");
    const tableWrap  = document.getElementById("tableWrap");
    const tbody      = document.querySelector("#resultTable tbody");
    const statusEl   = document.getElementById("status");

    let sortKey = "style_num";
    let sortAsc = true;

    let shippingLevels = [];
    let shippingLevelsLoaded = false;

    async function loadShippingLevels(){
      try {
        const url = new URL(API_LEVELS);
      url.searchParams.set("select","shipping_level,min_weight,max_weight,shipping_per_item,shipping_min,handling_per_item,handling_min");
        url.searchParams.set("order","min_weight.asc");
        const res = await fetch(url.toString(), {
          headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` },
          cache: "no-store"
        });
        if(!res.ok) throw new Error("shipping levels failed");
        shippingLevels = await res.json();
        shippingLevelsLoaded = true;
      } catch(err){
        console.error("Failed to load shipping levels", err);
        shippingLevels = [];
        shippingLevelsLoaded = false;
      }
    }

    // kick off loading levels in background
    loadShippingLevels();

    function findShippingForWeight(weight){
      const w = Number(weight || 0);
      if (!shippingLevels.length || !isFinite(w)) return null;
      return shippingLevels.find(level =>
        w >= Number(level.min_weight) && w <= Number(level.max_weight)
      ) || null;
    }

    function syncBoxes(){
      const styleHasText = itemInput.value.trim().length > 0;
      const descHasText  = descInput.value.trim().length > 0;

      if (styleHasText){
        // Item # takes priority
        descInput.value = "";
        descInput.disabled = true;
      } else {
        descInput.disabled = false;
      }

      if (descHasText){
        // Description-only search
        itemInput.value = "";
        itemInput.disabled = true;
      } else {
        itemInput.disabled = false;
      }
    }

    function render(rows){
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        const lb = Number(r.piece_weight || 0);
        const ship = findShippingForWeight(lb);

      tr.innerHTML = `
  <td><span class="badge">${r.vendor || ""}</span></td>
  <td>${r.style_num || ""}</td>
  <td>${r.product_title || ""}</td>
  <td>${r.size || ""}</td>
  <td>${lb ? lb.toFixed(2) : ""}</td>
  <td>${ship ? `Level ${ship.shipping_level}` : ""}</td>

  <td>${ship ? `$${ship.shipping_min.toFixed(2)}` : ""}</td>
  <td>${ship ? `$${ship.shipping_per_item.toFixed(2)}` : ""}</td>

  <td>${ship ? `$${ship.handling_min.toFixed(2)}` : ""}</td>
  <td>${ship ? `$${ship.handling_per_item.toFixed(2)}` : ""}</td>
`;
        tbody.appendChild(tr);
      });
      statusEl.textContent = rows.length ? `${rows.length} item(s) found` : "No results";
    }

    async function fetchExactItem(styleRaw){
      const style = styleRaw.trim().replace(/[\s\-]+/g, "");
      const url = new URL(API_ITEMS);
      url.searchParams.set("select","vendor,style_num,product_title,product_description,size,piece_weight");
      url.searchParams.set("style_num", `ilike.${style}`);
      url.searchParams.set("order", `${sortKey}.${sortAsc ? "asc" : "desc"}`);
      url.searchParams.set("limit","200");

      const res = await fetch(url.toString(), {
        headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` },
        cache: "no-store"
      });
      if(!res.ok){
        const txt = await res.text();
        console.error("Exact item error", res.status, txt);
        throw new Error("API error");
      }
      return res.json();
    }

    async function fetchByDescription(term){
      const url = new URL(API_ITEMS);
      url.searchParams.set("select","vendor,style_num,product_title,product_description,size,piece_weight");
      url.searchParams.set("limit","200");
      const like = `*${term}*`;
      url.searchParams.set("or", `(product_title.ilike.${like},product_description.ilike.${like})`);
      url.searchParams.set("order", `${sortKey}.${sortAsc ? "asc" : "desc"}`);

      const res = await fetch(url.toString(), {
        headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` },
        cache: "no-store"
      });
      if(!res.ok){
        const txt = await res.text();
        console.error("Description search error", res.status, txt);
        throw new Error("API error");
      }
      return res.json();
    }

    function debounce(fn, ms=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    const runSearch = debounce(async ()=>{
      syncBoxes();

      const style = itemInput.value.trim();
      const desc  = descInput.value.trim();

      // ensure shipping levels attempt at least once
      if (!shippingLevelsLoaded && !shippingLevels.length){
        await loadShippingLevels();
      }

      // 1) Item # first if present
      if (style.length > 0){
        statusEl.textContent = "Searching by exact Item #…";
        try{
          const rows = await fetchExactItem(style);
          tableWrap.style.display = rows.length ? "block" : "none";
          render(rows);
        }catch(e){
          console.error(e);
          tableWrap.style.display = "none";
          statusEl.textContent = "Search failed.";
        }
        return;
      }

      // 2) Description if 2+ chars
      if (desc.length >= 2){
        statusEl.textContent = "Searching by description…";
        try{
          const rows = await fetchByDescription(desc);
          tableWrap.style.display = rows.length ? "block" : "none";
          render(rows);
        }catch(e){
          console.error(e);
          tableWrap.style.display = "none";
          statusEl.textContent = "Search failed.";
        }
        return;
      }

      // 3) Nothing to search
      tableWrap.style.display = "none";
      tbody.innerHTML = "";
      statusEl.textContent = "Type an Item # (exact) or at least 2 characters in Description.";
    }, 160);

    // Clear button
    clearBtn.addEventListener("click", () => {
      itemInput.value = "";
      descInput.value = "";
      tbody.innerHTML = "";
      tableWrap.style.display = "none";
      statusEl.textContent = "Type an Item # (exact) or at least 2 characters in Description.";
      itemInput.disabled = false;
      descInput.disabled = false;
    });

    // Wire inputs
    itemInput.addEventListener("input", runSearch);
    descInput.addEventListener("input", runSearch);

    // Clickable headers for sorting
    document.querySelectorAll("th[data-k]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.k;
        if (!key) return;

        if (sortKey === key) {
          sortAsc = !sortAsc;
        } else {
          sortKey = key;
          sortAsc = true;
        }
        runSearch();
      });
    });

    // Hide table initially
    tableWrap.style.display = "none";
  });
</script>
</body>
</html>
