<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Item Weight & Shipping Lookup</title>

  <!-- =========================================================
       SECTION 2: PAGE STYLES
       ========================================================= -->
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #fff;
      color: #111;
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      color: #000;
      margin-bottom: 4px;
    }
    .sub {
      color: #555;
      margin: 0 0 18px;
      font-size: 14px;
    }
    .search-bar {
      display: grid;
      grid-template-columns: 1fr 1fr 120px;
      gap: 10px;
      margin-bottom: 10px;
    }
    input,
    button,
    select {
      padding: 10px;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }
    input {
      border: 1px solid #ccc;
    }
    input:focus {
      border-color: #c40000;
      outline: none;
      box-shadow: 0 0 0 2px rgba(196, 0, 0, 0.15);
    }
    button {
      background: #c40000;
      color: #fff;
      border: 1px solid #c40000;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      filter: brightness(0.93);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 13px;
    }
    th {
      background: #f4f4f4;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    tr:hover td {
      background: #f9f9f9;
    }
    .muted {
      color: #555;
      font-size: 13px;
      margin-top: 4px;
    }
    .vendor-pill {
      background: #c40000;
      padding: 6px 12px;
      border-radius: 22px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: default;
      user-select: none;
      border: none;
    }
    .quote-label {
      background: #222;
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      display: inline-block;
    }
    .pagination {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    th.active {
      background: #c40000;
      color: #fff;
    }
    th .sort-icon {
      margin-left: 6px;
      font-size: 11px;
      color: #777;
    }
    th.active .sort-icon {
      color: #fff;
    }
    @media (max-width: 760px) {
      .search-bar { grid-template-columns: 1fr; }
      th, td { font-size: 12px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Item Weight & Shipping Lookup</h1>
  <p class="sub">Search by <b>Item # (exact)</b> or <b>Description keywords</b>.<br>Results include vendor, weight (3 decimals), and shipping/handling levels.</p>

  <!-- SEARCH BAR -->
  <div class="search-bar">
    <input id="itemInput" placeholder="Clear description to search by item number" />
    <input id="descInput" placeholder="Description keywords" />
    <button id="clearBtn">Clear</button>
  </div>

  <div id="status" class="muted">Type an Item # (exact) or at least 2 characters in Description.</div>

  <!-- TABLE -->
  <div id="tableWrap" style="display:none;">
    <table id="resultTable">
      <thead>
        <tr>
          <th data-k="vendor">Vendor <span class="sort-icon">⬍</span></th>
          <th data-k="style_num">Style # <span class="sort-icon">⬍</span></th>
          <th data-k="product_title">Title <span class="sort-icon">⬍</span></th>
          <th data-k="size">Size <span class="sort-icon">⬍</span></th>
          <th data-k="piece_weight">Weight (lb) <span class="sort-icon">⬍</span></th>
          <th data-k="ship_level">Ship Level <span class="sort-icon">⬍</span></th>
          <th data-k="ship_min">Shipping $ min <span class="sort-icon">⬍</span></th>
          <th data-k="ship_item">Shipping $/Item <span class="sort-icon">⬍</span></th>
          <th data-k="hand_min">Handling $ min <span class="sort-icon">⬍</span></th>
          <th data-k="hand_item">Handling $/Item <span class="sort-icon">⬍</span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination">
      <button id="prevBtn">Previous</button>
      <span id="pageTop" class="page-info"></span>
      <select id="pageJump"></select>
      <span id="pageBottom" class="page-info"></span>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- =========================================================
     SCRIPT START
========================================================= -->
<script>
// SECTION 12: CONSTANTS
const SUPABASE_URL = "https://sbfslzwnkztmodnlsigq.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg";
const API_ITEMS = `${SUPABASE_URL}/rest/v1/items_unified`;
const API_LEVELS = `${SUPABASE_URL}/rest/v1/shipping_levels`;

// SORT DEFAULTS
let sortKey = "style_num";
let sortAsc = true;

// PAGINATION
let page = 0;
const pageSize = 50;
let currentRows = [];
let shippingLevels = [];
let shippingLevelsLoaded = false;

// SECTION 16: SORT MAP
const SORT_MAP = {
  vendor: r => r.vendor?.toLowerCase() || "",
  style_num: r => r.style_num?.toLowerCase() || "",
  product_title: r => r.product_title?.toLowerCase() || "",
  size: r => r.size?.toLowerCase() || "",
  piece_weight: r => parseFloat(r.piece_weight) || 0,

  ship_level: r => {
    const w = parseFloat(r.piece_weight) || 0;
    const lvl = shippingLevels.find(l => w >= l.min_weight && w <= l.max_weight);
    return lvl ? Number(lvl.shipping_level) : 9999;
  },
  ship_min: r => {
    const w = parseFloat(r.piece_weight) || 0;
    const lvl = shippingLevels.find(l => w >= l.min_weight && w <= l.max_weight);
    return lvl ? Number(lvl.shipping_min) : Infinity;
  },
  ship_item: r => {
    const w = parseFloat(r.piece_weight) || 0;
    const lvl = shippingLevels.find(l => w >= l.min_weight && w <= l.max_weight);
    return lvl ? Number(lvl.shipping_per_item) : Infinity;
  },
  hand_min: r => {
    const w = parseFloat(r.piece_weight) || 0;
    const lvl = shippingLevels.find(l => w >= l.min_weight && w <= l.max_weight);
    return lvl ? Number(lvl.handling_min) : Infinity;
  },
  hand_item: r => {
    const w = parseFloat(r.piece_weight) || 0;
    const lvl = shippingLevels.find(l => w >= l.min_weight && w <= l.max_weight);
    return lvl ? Number(lvl.handling_per_item) : Infinity;
  },
};

// UPDATE SORT HEADER
function updateSortHeader() {
  document.querySelectorAll("th[data-k]").forEach(th => {
    th.classList.remove("active");
    const icon = th.querySelector(".sort-icon");
    if (icon) icon.textContent = "⬍";
  });
  const active = document.querySelector(`th[data-k="${sortKey}"]`);
  if (active) {
    active.classList.add("active");
    const icon = active.querySelector(".sort-icon");
    if (icon) icon.textContent = sortAsc ? "▲" : "▼";
  }
}

// APPLY SORT
function applySort(key) {
  if (sortKey === key) {
    sortAsc = !sortAsc;
  } else {
    sortKey = key;
    sortAsc = true;
  }

  currentRows.sort((a, b) => {
    const A = SORT_MAP[key](a);
    const B = SORT_MAP[key](b);
    if (A === B) return 0;
    return sortAsc ? (A > B ? 1 : -1) : (A < B ? 1 : -1);
  });

  updateSortHeader();
  render(currentRows);
}

// LOAD SHIPPING LEVELS
async function loadShippingLevels() {
  try {
    const url = new URL(API_LEVELS);
    url.searchParams.set("select", "*");
    url.searchParams.set("order", "min_weight.asc");

    const res = await fetch(url, {
      headers: {
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${SUPABASE_ANON}`
      }
    });

    if (!res.ok) throw new Error("level load fail");
    shippingLevels = await res.json();
    shippingLevelsLoaded = true;
  } catch {
    shippingLevels = [];
  }
}

// FETCH ITEMS
async function fetchItems() {
  const styleRaw = itemInput.value.trim();
  const desc = descInput.value.trim();
  const style = styleRaw.toUpperCase();

  if (!shippingLevelsLoaded) await loadShippingLevels();

  const url = new URL(API_ITEMS);
  url.searchParams.set("select", "vendor,style_num,product_title,product_description,size,piece_weight");

  if (style.length > 0) {
    url.searchParams.set("style_num", `eq.${style}`);
  } else if (desc.length >= 2) {
    url.searchParams.set("or", `(product_title.ilike.*${desc}*,product_description.ilike.*${desc}*)`);
  } else {
    tableWrap.style.display = "none";
    tbody.innerHTML = "";
    statusEl.textContent = "Type an Item # (exact) or at least 2 characters in Description.";
    return;
  }

  try {
    const res = await fetch(url, {
      headers: {
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${SUPABASE_ANON}`
      }
    });

    currentRows = await res.json();
    page = 0;
    render(currentRows);
  } catch {
    statusEl.textContent = "Search failed.";
  }
}

// RENDER TABLE
function render(rows) {
  tbody.innerHTML = "";
  tableWrap.style.display = rows.length ? "block" : "none";

  const totalPages = Math.ceil(rows.length / pageSize);
  const start = page * pageSize;
  const slice = rows.slice(start, start + pageSize);

  pageTop.textContent = `Page ${page + 1} of ${totalPages}`;
  pageBottom.textContent = `Page ${page + 1} of ${totalPages}`;

  pageJump.innerHTML = "";
  for (let i = 0; i < totalPages; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Go to page ${i + 1}`;
    if (i === page) opt.selected = true;
    pageJump.appendChild(opt);
  }

  slice.forEach(item => {
    const tr = document.createElement("tr");

    const weight = parseFloat(item.piece_weight) || 0;
    const lvl = shippingLevels.find(l => weight >= l.min_weight && weight <= l.max_weight);

    let levelLabel, shipMin, shipItem, handMin, handItem;

    if (!lvl) {
      levelLabel = `<span class="quote-label" title="This item requires a manual shipping quote due to weight.">Shipping Quote Required</span>`;
      shipMin = shipItem = handMin = handItem = "—";
    } else {
      levelLabel = `Level ${lvl.shipping_level}`;
      shipMin = `$${lvl.shipping_min.toFixed(2)}`;
      shipItem = `$${lvl.shipping_per_item.toFixed(2)}`;
      handMin = `$${lvl.handling_min.toFixed(2)}`;
      handItem = `$${lvl.handling_per_item.toFixed(2)}`;
    }

    tr.innerHTML = `
      <td><span class="vendor-pill">${item.vendor}</span></td>
      <td>${item.style_num}</td>
      <td>${item.product_title}</td>
      <td>${item.size}</td>
      <td>${weight.toFixed(3)}</td>
      <td>${levelLabel}</td>
      <td>${shipMin}</td>
      <td>${shipItem}</td>
      <td>${handMin}</td>
      <td>${handItem}</td>
    `;

    tbody.appendChild(tr);
  });

  prevBtn.disabled = page === 0;
  nextBtn.disabled = (page + 1) * pageSize >= rows.length;
}

// EVENT LISTENERS
itemInput.addEventListener("input", fetchItems);
descInput.addEventListener("input", fetchItems);
clearBtn.addEventListener("click", () => {
  itemInput.value = "";
  descInput.value = "";
  currentRows = [];
  tbody.innerHTML = "";
  tableWrap.style.display = "none";
  statusEl.textContent = "Type an Item # (exact) or at least 2 characters in Description.";
});

document.querySelectorAll("th[data-k]").forEach(th => {
  th.addEventListener("click", () => applySort(th.dataset.k));
});

prevBtn.addEventListener("click", () => {
  if (page > 0) {
    page--;
    render(currentRows);
  }
});

nextBtn.addEventListener("click", () => {
  if ((page + 1) * pageSize < currentRows.length) {
    page++;
    render(currentRows);
  }
});

pageJump.addEventListener("change", () => {
  page = parseInt(pageJump.value, 10) || 0;
  render(currentRows);
});

</script>
</body>
</html>