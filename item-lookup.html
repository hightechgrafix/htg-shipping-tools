<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       SECTION 1: DOCUMENT HEAD
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Item Weight & Shipping Lookup</title>

  <!-- =========================================================
       SECTION 2: PAGE STYLES
       ========================================================= -->
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #fff;
      color: #111;
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      color: #000;
      margin-bottom: 4px;
    }
    .sub {
      color: #555;
      margin: 0 0 18px;
      font-size: 14px;
    }
    .search-bar {
      display: grid;
      grid-template-columns: 1fr 1fr 120px;
      gap: 10px;
      margin-bottom: 10px;
    }
    input,
    button,
    select {
      padding: 10px;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }
    input {
      border: 1px solid #ccc;
    }
    input:focus {
      border-color: #c40000;
      outline: none;
      box-shadow: 0 0 0 2px rgba(196, 0, 0, 0.15);
    }
    button {
      background: #c40000;
      color: #fff;
      border: 1px solid #c40000;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      filter: brightness(0.93);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 13px;
    }
    th {
      background: #f4f4f4;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    tr:hover td {
      background: #f9f9f9;
    }
    .muted {
      color: #555;
      font-size: 13px;
      margin-top: 4px;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 11px;
      background: #fafafa;
    }
    #tableWrap {
      display: none;
    }
    .pagination {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pagination button {
      font-size: 14px;
    }
    .page-info {
      font-size: 14px;
      font-weight: bold;
    }
    .sort-icon {
      font-size: 12px;
      margin-left: 6px;
      color: #aaa;
    }
    th.active {
      background-color: #c40000;
      color: #fff;
    }
    th.active .sort-icon {
      color: #fff;
    }
    @media (max-width: 760px) {
      .search-bar {
        grid-template-columns: 1fr;
      }
      th,
      td {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- =========================================================
       SECTION 3: PAGE HEADER
       ========================================================= -->
  <div class="container">
    <h1>Item Weight & Shipping Lookup</h1>
    <p class="sub">
      Search by <strong>Item # (exact)</strong> or <strong>Description keywords</strong>.<br />
      Results include vendor, weight (3 decimals), and shipping/handling levels.
    </p>

    <!-- =========================================================
         SECTION 4: SEARCH BAR
         ========================================================= -->
    <div class="search-bar">
      <input type="text" id="itemInput" placeholder="Item # (exact)">
      <input type="text" id="descInput" placeholder="Description keywords">
      <button id="clearBtn">Clear</button>
    </div>

    <!-- =========================================================
         SECTION 5: STATUS MESSAGE
         ========================================================= -->
    <div id="status" class="muted">
      Type an Item # (exact) or at least 2 characters in Description.
    </div>

    <!-- =========================================================
         SECTION 6: TABLE WRAPPER
         ========================================================= -->
    <div id="tableWrap">
      <!-- =======================================================
           SECTION 7: PAGINATION (TOP)
           ======================================================= -->
      <div class="pagination">
        <div class="page-info" id="pageTop"></div>
        <select id="pageJump"></select>
      </div>

      <!-- =======================================================
           SECTION 8: RESULTS TABLE
           ======================================================= -->
      <table id="resultTable">
        <thead>
          <tr>
            <th data-k="vendor">Vendor <span class="sort-icon">⬍</span></th>
            <th data-k="style_num">Style # <span class="sort-icon">⬍</span></th>
            <th data-k="product_title">Title <span class="sort-icon">⬍</span></th>
            <th data-k="size">Size <span class="sort-icon">⬍</span></th>
            <th data-k="piece_weight">Weight (lb) <span class="sort-icon">⬍</span></th>
            <th data-k="ship_level">Ship Level <span class="sort-icon">⬍</span></th>
            <th>Shipping $ min</th>
            <th>Shipping $/Item</th>
            <th>Handling $ min</th>
            <th>Handling $/Item</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- =======================================================
           SECTION 9: PAGINATION (BOTTOM)
           ======================================================= -->
      <div class="pagination">
        <button id="prevBtn">Previous</button>
        <div class="page-info" id="pageBottom"></div>
        <button id="nextBtn">Next</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       SECTION 10: END OF PAGE HTML
       ========================================================= -->

  <!-- =========================================================
       SECTION 11: SCRIPT START
       ========================================================= -->
  <script>
    // =========================================================
    // SECTION 12: CONFIG CONSTANTS
    // =========================================================
    const SUPABASE_URL = "https://sbfslzwnkztmodnlsigq.supabase.co";
    const SUPABASE_ANON =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZnNsendua3p0bW9kbmxzaWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTQ5NTgsImV4cCI6MjA3ODM3MDk1OH0.ebZ1IvA5FQN7EhIcluJvw3OqMFU4Czkhin_ffTPx9vg";

    const API_ITEMS = `${SUPABASE_URL}/rest/v1/items_unified`;
    const API_LEVELS = `${SUPABASE_URL}/rest/v1/shipping_levels`;

    // Default sort: Style # ascending
    let sortKey = "style_num";
    let sortAsc = true;

    // Pagination
    let page = 0;
    const pageSize = 50;
    let totalPages = 0;

    // =========================================================
    // SECTION 13: GLOBAL STATE
    // =========================================================
    let shippingLevels = [];
    let shippingLevelsLoaded = false;
    let currentRows = [];

    // =========================================================
    // SECTION 14: PAGE INIT
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      // -------------------------------------------------------
      // SECTION 15: DOM ELEMENT REFERENCES
      // -------------------------------------------------------
      const itemInput = document.getElementById("itemInput");
      const descInput = document.getElementById("descInput");
      const clearBtn = document.getElementById("clearBtn");
      const tableWrap = document.getElementById("tableWrap");
      const tbody = document.querySelector("#resultTable tbody");
      const statusEl = document.getElementById("status");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const pageTop = document.getElementById("pageTop");
      const pageBottom = document.getElementById("pageBottom");
      const pageJump = document.getElementById("pageJump");

      // -------------------------------------------------------
      // SECTION 16: SORTING HEADER UI INIT
      // -------------------------------------------------------
      function setInitialSortHeader() {
        const headers = document.querySelectorAll("th[data-k]");
        headers.forEach((h) => {
          h.classList.remove("active");
          const icon = h.querySelector(".sort-icon");
          if (icon) icon.textContent = "⬍";
        });

        const initialHeader = document.querySelector(`th[data-k="${sortKey}"]`);
        if (initialHeader) {
          initialHeader.classList.add("active");
          const icon = initialHeader.querySelector(".sort-icon");
          if (icon) icon.textContent = sortAsc ? "▲" : "▼";
        }
      }
      setInitialSortHeader();

      // -------------------------------------------------------
      // SECTION 17: SORTING LOGIC
      // -------------------------------------------------------
      document.querySelectorAll("th[data-k]").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.k;
          if (!key) return;

          if (sortKey === key) {
            sortAsc = !sortAsc;
          } else {
            sortKey = key;
            sortAsc = true;
          }

          document.querySelectorAll("th[data-k]").forEach((h) => {
            h.classList.remove("active");
            const icon = h.querySelector(".sort-icon");
            if (icon) icon.textContent = "⬍";
          });

          th.classList.add("active");
          const icon = th.querySelector(".sort-icon");
          if (icon) icon.textContent = sortAsc ? "▲" : "▼";

          page = 0;
          render(currentRows);
        });
      });

      // -------------------------------------------------------
      // SECTION 18: LOAD SHIPPING LEVELS
      // -------------------------------------------------------
      async function loadShippingLevels() {
        try {
          const url = new URL(API_LEVELS);
          url.searchParams.set("select", "*");
          url.searchParams.set("order", "min_weight.asc");

          const res = await fetch(url.toString(), {
            headers: {
              apikey: SUPABASE_ANON,
              Authorization: `Bearer ${SUPABASE_ANON}`,
            },
            cache: "no-store",
          });

          if (!res.ok) throw new Error("shipping levels failed");
          shippingLevels = await res.json();
          shippingLevelsLoaded = true;
        } catch (err) {
          console.error("Failed to load shipping levels:", err);
          shippingLevels = [];
          shippingLevelsLoaded = false;
        }
      }

      // -------------------------------------------------------
      // SECTION 19: FIND SHIPPING LEVEL FOR WEIGHT
      // -------------------------------------------------------
      function findShippingForWeight(weight) {
        const w = Number(weight);
        if (!shippingLevels.length || !isFinite(w) || w <= 0) return null;

        return (
          shippingLevels.find((lvl) => {
            const min = Number(lvl.min_weight);
            const max = Number(lvl.max_weight);
            return w >= min && w <= max;
          }) || null
        );
      }

           // =========================================================
// SECTION 20: RENDER TABLE (UPDATED WITH QUOTE LOGIC)
// =========================================================
function render(rows) {
  tbody.innerHTML = "";
  tableWrap.style.display = rows.length ? "block" : "none";

  const totalPages = Math.ceil(rows.length / pageSize);
  const start = page * pageSize;
  const end = start + pageSize;
  const slice = rows.slice(start, end);

  pageTop.textContent = `Page ${page + 1} of ${totalPages}`;
  pageBottom.textContent = `Page ${page + 1} of ${totalPages}`;

  pageJump.innerHTML = "";
  for (let i = 0; i < totalPages; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Go to page ${i + 1}`;
    if (i === page) opt.selected = true;
    pageJump.appendChild(opt);
  }

  slice.forEach((item) => {
    const tr = document.createElement("tr");

    const weight = parseFloat(item.piece_weight) || 0;
    const levelObj = shippingLevels.find(
      (lvl) => weight >= lvl.min_weight && weight <= lvl.max_weight
    );

    let levelLabel, shipMin, shipItem, handMin, handItem;

    if (!levelObj) {
      // ---------- QUOTE MODE ----------
      levelLabel = `
        <span class="quote-label" title="This item requires a manual shipping quote due to weight.">
          Shipping Quote Required
        </span>
      `;
      shipMin = "—";
      shipItem = "—";
      handMin = "—";
      handItem = "—";
    } else {
      // ---------- NORMAL LEVEL ----------
      levelLabel = `Level ${levelObj.shipping_level}`;
      shipMin = `$${levelObj.shipping_min.toFixed(2)}`;
      shipItem = `$${levelObj.shipping_per_item.toFixed(2)}`;
      handMin = `$${levelObj.handling_min.toFixed(2)}`;
      handItem = `$${levelObj.handling_per_item.toFixed(2)}`;
    }

    tr.innerHTML = `
      <td><button class="vendor-btn">${item.vendor}</button></td>
      <td>${item.style_num}</td>
      <td>${item.product_title}</td>
      <td>${item.size}</td>
      <td>${weight.toFixed(3)}</td>
      <td>${levelLabel}</td>
      <td>${shipMin}</td>
      <td>${shipItem}</td>
      <td>${handMin}</td>
      <td>${handItem}</td>
    `;

    tbody.appendChild(tr);
  });

  prevBtn.disabled = page === 0;
  nextBtn.disabled = page + 1 >= totalPages;
}
      // -------------------------------------------------------
// SECTION 21: FETCH ITEMS (CASE-INSENSITIVE SEARCH FIXED)
// -------------------------------------------------------
async function fetchItems() {
  const style = itemInput.value.trim();
  const desc  = descInput.value.trim();

  if (!shippingLevelsLoaded) {
    await loadShippingLevels();
  }

  const url = new URL(API_ITEMS);
  url.searchParams.set(
    "select",
    "vendor,style_num,product_title,product_description,size,piece_weight"
  );

  if (style.length > 0) {
    // Case-insensitive exact style match
    url.searchParams.set("style_num", `ilike.${style}`);
  } else if (desc.length >= 2) {
    // Case-insensitive description search
    const like = `*${desc}*`;
    url.searchParams.set(
      "or",
      `(product_title.ilike.${like},product_description.ilike.${like})`
    );
  } else {
    tableWrap.style.display = "none";
    tbody.innerHTML = "";
    statusEl.textContent =
      "Type an Item # (exact) or at least 2 characters in Description.";
    return;
  }

  if (sortKey !== "ship_level") {
    url.searchParams.set(
      "order",
      `${sortKey}.${sortAsc ? "asc" : "desc"}`
    );
  }

  url.searchParams.set("limit", "1000");

  try {
    const res = await fetch(url.toString(), {
      headers: {
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${SUPABASE_ANON}`,
      },
      cache: "no-store",
    });

    if (!res.ok) throw new Error("API error");

    currentRows = await res.json();
    page = 0;
    render(currentRows);
  } catch (err) {
    console.error("Item fetch failed:", err);
    tableWrap.style.display = "none";
    statusEl.textContent = "Search failed.";
  }
}

      // -------------------------------------------------------
      // SECTION 22: SEARCH DEBOUNCE
      // -------------------------------------------------------
      const runSearch = (() => {
        let t;
        return () => {
          clearTimeout(t);
          t = setTimeout(fetchItems, 160);
        };
      })();

      // -------------------------------------------------------
      // SECTION 23: EVENT LISTENERS
      // -------------------------------------------------------
      clearBtn.addEventListener("click", () => {
        itemInput.value = "";
        descInput.value = "";
        currentRows = [];
        page = 0;
        tbody.innerHTML = "";
        tableWrap.style.display = "none";
        statusEl.textContent =
          "Type an Item # (exact) or at least 2 characters in Description.";

        pageTop.textContent = "";
        pageBottom.textContent = "";
        pageJump.innerHTML = "";
      });

      itemInput.addEventListener("input", runSearch);
      descInput.addEventListener("input", runSearch);

      prevBtn.addEventListener("click", () => {
        if (page > 0) {
          page--;
          render(currentRows);
        }
      });

      nextBtn.addEventListener("click", () => {
        if ((page + 1) * pageSize < currentRows.length) {
          page++;
          render(currentRows);
        }
      });

      pageJump.addEventListener("change", () => {
        page = parseInt(pageJump.value, 10) || 0;
        render(currentRows);
      });
    }); <!-- THIS NOW MATCHES THE OPENING DOMContentLoaded -->

    // =========================================================
    // SECTION 24: END OF SCRIPT
    // =========================================================
  </script>
</body>
</html>

      